<div class="row">
	<div id="breadcrumb" class="col-xs-12">
		<ol class="breadcrumb pull-left">
			<li><a class="ajax-link" href="./ajax/dashboard.html">首页</a></li>
			<li><a href="#">安全管理</a></li>
			<li><a href="#">告警列表</a></li>
		</ol>
	</div>
	<!-- /#breadcrumb -->
</div>
<!-- /.row -->

<div class="row">
	<div class="col-xs-12">
		<div class="box no-drop">
			<div class="box-header">
				<div class="box-name">
					<span>告警列表：</span>
				</div>
				<div class="box-icons">
					<a class="collapse-link">
						<i class="fa fa-chevron-up"></i>
					</a>
					<!-- <a class="expand-link">
						<i class="fa fa-expand"></i>
					</a> -->
				</div>
				<div class="no-move"></div>
			</div>
			<div class="box-content clearfix">
				<form action="alarmFilter" id="alarmFilterForm" class="form-inline col-xs-12">
					<div class="form-group mr">
						<label class="control-label">过滤：</label>
						<input type="text" name="incident_id" class="form-control" placeholder="ID">
						<input type="text" name="incident_src" class="form-control" placeholder="告警源IP">
						<!-- <div class="radio-inline"><input type="radio" value="3" name="filter"> 自定义</div> -->
					</div>
					<div class="form-group mr">
						<label for="" class="control-label">分组：</label>
						<select id="columnFilter" class="form-control" data-placeholder="不分组(详情和时间)" multiple>
							<option value="latest_time">最近发生时间</option>
							<option value="creation_time">第一次发生时间</option>
							<option value="incident_et">告警类型</option>
							<option value="incident_src">告警源</option>
							<option value="incident_target">告警目标</option>
							<option value="incident_detail">告警详情</option>
							<option value="severity">严重级别</option>
							<option value="incident_status">告警状态</option>
						</select>
					</div>
					<div class="form-group mr">
						<label for="" class="control-label">严重性：</label>
						<select name="severitycat" class="form-control">
							<option value="7">所有</option>
							<option value="4" class="level-high">高</option>
							<option value="6" class="level-high">高+中</option>
							<option value="2" class="level-mid">中</option>
							<option value="1" class="level-low">低</option>
						</select>
					</div>
					<div class="form-group mr">
						<label for="" class="control-label">功能：</label>
						
						<select name="rule_attribute" class="form-control">
							<option value="">所有</option>
							<option value="secu">安全</option>
							<option value="perf">性能</option>
							<option value="avai">可用性</option>
							<option value="change">变更</option>
						</select>
						
					</div>
					<div class="form-group mr">
						<label for="" class="control-label">时间：</label>
						<label class="radio-inline">
							<input type="radio" class="period" name="timeType" value="0" checked> 相对时间
						</label>
						<label class="radio-inline">
							<input type="radio" class="period" name="timeType" value="1"> 绝对时间
						</label>
					</div>

					<div class="form-group mr">
						<div class="period-relative hide">
							最后<input type="number" class="relative-time form-control" id="timeNum" value="2">
							<input type="hidden" class="relative-time form-control" id="timeVal" name="timeVal">
							<select id="timeUnit" class="form-control">
								<option value="60000">分钟</option>
								<option value="3600000">小时</option>
								<option value="86400000">天</option>
							</select>
						</div>
						<div class="period-absolute hide">
							<div class="col-xs-6">
								<input type="text" id="startTime" name="startTime" class="form-control date-picker absolute-time" placeholder="开始时间">
							</div>
							<div class="col-xs-6">
								<input type="text" id="endTime" name="endTime" class="form-control date-picker absolute-time" placeholder="结束时间">
							</div>
						</div>
					</div>

					<div class="form-group mr">
						<input type="submit" class="btn btn-default" value="筛 选">
					</div>
					
				</form>
				<div class="col-xs-12">
					<table id="alarmTable" class="mt-20 table table-condensed table-striped  table-block table-hover byoneTable">
						<thead>
							<tr>
								<th>告警等级</th>
								<th>最近发生时间</th>
								<th>第一次发生时间</th>
								<th>告警类型</th>
								<th>告警源</th>
								<th>告警目标</th>
								<th>告警详情</th>
								<th>告警状态</th>
								<th>告警数</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
					<div class="zoom loading">
						<div class="spinner"></div>
					</div>
					<nav class="pull-right">
						<ul class="pagination" id="alarmPag">
							<li class="prev"><a href="#">&laquo;</a></li>
							<li class="next"><a href="#">&raquo;</a></li>
						</ul>
					</nav>
				</div>
				<!-- /.col-xs-12 -->
				<div class="col-xs-12">
					<table id="triggerTable" class="table table-condensed table-striped  table-block table-hover byoneTable">
						<caption>触发的事件</caption>
						<thead>
							<tr>
								<th>hostIpAddr</th>
								<th>srcIpAddr</th>
								<th>reptDevIpAddr</th>
								<th>eventType</th>
								<th>eventName</th>
								<th>phRecvTime</th>
								<th>eventSeverityCat</th>
								<th>rawEventMsg</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
				<!-- /.col-xs-12 -->
			</div>
			<!-- /.box-content -->
		</div>
		<!-- /.box -->
	</div>
	<!-- /.col-xs-12 -->

</div>
<!-- /.row -->


<!-- Modal -->
<!-- <div class="modal fade" id="triggerModal" tabindex="-1" role="dialog" aria-labelledby="triggerModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
				<h5 class="modal-title" id="triggerModalLabel">告警详情</h5>
			</div>
			<div class="modal-body clearfix">
				<table id="triggerTable" class="table table-condensed table-striped  table-block table-hover byoneTable">
					<caption>触发的事件</caption>
					<thead>
						<tr>
							<th>hostIpAddr</th>
							<th>srcIpAddr</th>
							<th>reptDevIpAddr</th>
							<th>eventType</th>
							<th>eventName</th>
							<th>phRecvTime</th>
							<th>eventSeverityCat</th>
							<th>rawEventMsg</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div> -->
<!-- /.modal -->

<script type="text/javascript">
	var __headList = {
		'severitycat': '告警等级',
		'latest_time': '最近发生时间',
		'creation_time': '第一次发生时间',
		'incident_et': '告警类型',
		'incident_src': '告警源',
		'incident_target': '告警目标',
		'incident_detail': '告警详情',
		'severity': '严重级别',
		'incident_status': '告警状态',
		'incident_count': '告警数'
	};


	function alarmPeriodType(event) {
		console.log('change');
		if ($(this).val() === '0') {
			$(this).closest('form')
			.find('.period-relative').removeClass('hide').show()
			.siblings('.period-absolute').hide();
		} else {
			$(this).closest('form')
			.find('.period-absolute').removeClass('hide').show()
			.siblings('.period-relative').hide();
		}
	}

	function AllTimePickers() {
		$('.date-picker').datetimepicker({
			timeFormat: "HH:00",
			dateFormat: "yy-mm-dd"
		});
	}

	function getAlarmData(formHandle, callback) {
		var $form = $(formHandle),
		_itemCount = 15,
		_columns = $('#columnFilter', $form).val() || ['latest_time', 'creation_time', 'incident_et', 'incident_src', 'incident_target', 'incident_detail', 'incident_status'],
		$loading = $('#alarmTable + .loading').show(),
		$thtr = $('#alarmTable>thead>tr').children('th').remove().end();
		/*首尾必填两列*/
		_columns.unshift('severitycat');
		_columns.push('incident_count');
		for (var i = 0; i < _columns.length; i++) {
			$('<th>').text(__headList[_columns[i]]).attr('title', __headList[_columns[i]]).appendTo($thtr);
		}
		var _formList = $form.serializeArray(),
		_attrs = {
			itemCount: _itemCount,
			draw: $('#alarmPag').data('draw') - 0 || 1
		};
		for (var i = 0; i < _formList.length; i++) {
			var _item = _formList[i],
			_itemVal = _item.value;
			if (_itemVal || _itemVal instanceof Array && _itemVal.length > 0) {
				_attrs[_item.name] = _itemVal;
			}
		}
		$.get('queryAllIncident.do', _attrs, function(data) {
			setTableData('#alarmTable', data.voList, _columns, {
				'severitycat': function(data) {
					console.log('ser');
					return '<span class="glyphicon glyphicon-exclamation-sign ' + ['level-low', 'level-mid', '', 'level-high'][data - 1] + '"></span>';
				}
			});
			setPages(data.draw, parseInt((data.total - 1)/_itemCount)+1, '#alarmPag');
			if (callback && typeof callback === 'function') {
				callback();
			}
			$loading.hide();
		});
	}
	function byTableReady() {
		tableTrClick('#alarmTable', function(alarmId) {
			$('#triggerTable').data('byoneTable', null).find('tbody *').remove().end().byoneTable({
				ajax: "queryEventByIncident.do",
				"sort":["hostIpAddr", 'asc'],
				"filter": {
					"id": alarmId,
					"timeType": $('.period:checked').val(),
					"timeVal": $('#timeVal').val(),
					"startTime": $('#startTime').val(),
					"endTime": $('#endTime').val()
				},
				"pagination": true,
				"columns":[{
					"sortable": false,
					"data": "hostIpAddr"
				},{
					"sortable": false,
					"data": "srcIpAddr"
				},{
					"sortable": false,
					"data": "reptDevIpAddr"
				},{
					"sortable": false,
					"data": "eventType"
				},{
					"sortable": false,
					"data": "eventName"
				},{
					"sortable": false,
					"data": "phRecvTime"
				},{
					"sortable": false,
					"data": "eventSeverityCat"
				},{
					"sortable": false,
					"data": "rawEventMsg"
				}]
			});
		})
	}

	$(document).ready(function() {
		//LoadByoneTableScripts(tableReady);
		LoadChosenScript(function() {
			$('#columnFilter').chosen({
				disable_search_threshold: 10,
				search_contains: true,
				width: "200px",
				no_results_text: "没有对应结果!"
			});
		});

		LoadTimePickerScript(AllTimePickers);
		$('.period').change(alarmPeriodType).filter('[value = "0"]').click().change();
		$('#timeNum, #timeUnit').change(function(event) {
			/* Act on the event */
			var _timeVal = $('#timeNum').val() * $('#timeUnit').val();
			if (!_timeVal) {
				alert('时间格式不正确！');
				return;
			}
			$('#timeVal').val(_timeVal);
		}).change();
		$('#alarmFilterForm').submit(function(event) {
			event.preventDefault();
			getAlarmData(this);
		});
		$('#alarmPag').delegate('a', 'click', function(event) {
			/* Act on the event */
			event.preventDefault();
			if ($(this).is('.disabled')) {
				return;
			}
			var $parentLi = $(this).closest('li'),
			_targetPage = $parentLi.attr('data-page');
			if (_targetPage) {
				$('#alarmPag').data('draw', _targetPage);
			} else {
				$('#alarmPag').data('draw', ($('#alarmPag').data('draw') + ($parentLi.hasClass('prev') ? -1 : 1)));
			}
			getAlarmData('#alarmFilterForm');
		});
		getAlarmData('#alarmFilterForm', function() {//开始默认显示第一条告警详情
			$('#alarmTable tbody tr:eq(1)').click();
		});

		LoadByoneTableScripts(byTableReady)
	});
</script>