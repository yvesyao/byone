<div class="row">
	<div id="breadcrumb" class="col-xs-12">
		<ol class="breadcrumb pull-left">
			<li><a class="ajax-link" href="./ajax/dashboard.html">首页</a></li>
			<li><a href="#">知识库</a></li>
			<li><a href="#">规则</a></li>
		</ol>
	</div>
	<!-- /#breadcrumb -->
</div>
<!-- /.row -->
<div class="row">
	<div class="col-xs-12">
		<div class="box no-drop">
			<div class="box-header">
				<div class="box-name">
					<span>资产信息</span>
				</div>
				<div class="box-icons">
					<a class="collapse-link">
						<i class="fa fa-chevron-up"></i>
					</a>
				<!-- <a class="expand-link">
					<i class="fa fa-expand"></i>
				</a> -->
			</div>
			<div class="no-move"></div>
		</div>
		<div class="box-content clearfix">
			<div class="col-sm-6 mb-half">
				<input type="text" class="form-control" id="ruleSearch" placeholder="输入查询条件">
			</div>
			<table id="ruleTable" class="table table-condensed table-striped table-bordered table-block table-hover rule-table byoneTable" action-handle="#ruleActions">
				<thead>
					<tr>
						<th>状态</th>
						<th>名称</th>
						<th>来源</th>
						<th>描述</th>
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
			
			<!-- /.col-sm-6 -->
		</div>
		<!-- /.box-content -->
	</div>
	<!-- /.box -->
	<div class="col-xs-12 mb" id="ruleActions">
		<!-- test 添加的onclik -->
		<a href="#" class="btn btn-default" onclick="addRule()" data-func="addRule()"><span class="glyphicon glyphicon-plus"></span> 添加</a>
		<a href="#" class="btn btn-default rely-on-table" data-func="modRule('{1}')" disabled><span class="glyphicon glyphicon-edit"></span> 编辑</a>
		<a href="#" class="btn btn-default rely-on-table" data-func="delRule('{1}')" disabled><span class="glyphicon glyphicon-trash"></span> 删除</a>
		<a href="#" class="btn btn-default rely-on-table" data-func="copyRule('{1}')" disabled><span class="glyphicon glyphicon-share"></span> 复制</a>
	</div>

</div>
<!-- /.col-xs-12 -->

<!-- <div class="dropdown right-click-menu" id="ruleDropMenu">
	<ul aria-labelledby="dropdownMenu" role="menu" class="dropdown-menu">
		<li id="add">
			<a href="#" onclick="addRule()" tabindex="-1"><span class="glyphicon glyphicon-plus"></span> 新建
			</a>
		</li>
		<li id="edit">
			<a href="#" onclick="modRule('{1}')" tabindex="-1"><span class="glyphicon glyphicon-edit"></span> 编辑
			</a>
		</li>
		<li id="copy">
			<a href="#" onclick="copyRule('{1}')" tabindex="-1"><span class="glyphicon glyphicon-share"></span> 复制
			</a>
		</li>
		<li id="del">
			<a href="#" tabindex="delRule('{1}')"><span class="glyphicon glyphicon-trash"></span> 删除
			</a>
		</li>
	</ul>
</div> -->
<div class="col-xs-12" id="ruleInfo">

	<!-- Nav tabs -->
	<ul class="nav nav-tabs" role="tablist">
		<li class="active"><a href="#tab-zonglan" role="tab">概述</a></li>
	</ul>

	<!-- Tab panes -->
	<div class="tab-content clearfix">
		<div class="tab-pane active clearfix" id="tab-zonglan">
			<div class="col-xs-12">
				<div class="row">
					<div class="col-xs-12">
						<label class="control-label col-sm-2 col-md-1">名称:</label>
						<div class="col-xs-10 col-sm-10 col-md-11">Account Locked: Server_12/27/2013</div>
					</div>
				</div>
				<!-- /.row -->
				<div class="row">
					<div class="col-xs-6 col-md-3">
						<label class="control-label col-xs-5">状态:</label>
						<div class="pull-left">激活的</div>
					</div>
					<div class="col-xs-6 col-md-3">
						<label class="control-label col-xs-5">类型:</label>
						<div class="pull-left">高级</div>
					</div>
					<div class="col-xs-6 col-md-3">
						<label class="control-label col-xs-5 col-md-7">通知频率:</label>
						<div class="pull-left">1 day</div>
					</div>
					<div class="col-xs-6 col-md-3">
						<label class="control-label col-xs-5 col-md-7">告警种类:</label>
						<div class="pull-left">Server</div>
					</div>
				</div>
				<!-- /.row -->
				<div class="row">
					<div class="col-xs-12">
						<label class="control-label col-sm-2 col-md-1">描述:</label>
						<div class="col-xs-10 col-sm-10 col-md-11">Detects account lockout caused by excessive logon failures</div>
					</div>
					<div class="col-xs-12">
						<label class="control-label col-sm-2 col-md-1">条件:</label>
						<div class="col-xs-10 col-sm-10 col-md-11">
							<table>
								<tr>
									<td class="green-label">PATTERN</td>
									<td>
										<span class="purple-pattern">backdoorfound</span>
									</td>
								</tr>
								<tr>
									<td class="green-label">OCCURS</td>
									<td> in any 300 second time window</td>
								</tr>
							</table>
						</div>
					</div>
					<div class="col-xs-12">
						<label class="control-label col-sm-2 col-md-1">告警:</label>
						<div class="col-xs-10 col-sm-10 col-md-11">
							<table>
								<tr>
									<td class="green-label">GENERATE</td> 
									<td>Severity  9  <span class="level">(HIGH)</span>  Incident:  <strong>Backdoor_Attack_detected_by_NIPS</strong>   Display Name: <strong>Backdoor Attack detected by NIPS</strong></td>
								</tr>
								<tr>
									<td class="green-label">WITH</td>
									<td>源IP  =  <span class="purple-pattern">backdoorfound</span>.源IP, 目标IP  =  <span class="purple-pattern">backdoorfound</span>.目标IP</td>
								</tr>
							</table>
						</div>
					</div>
				</div>
				<!-- /.row -->

				<div class="row">
					<div class="col-xs-12">
						<label class="control-label col-xs-12">模式定义:</label>
						<div class="col-xs-12 pattern">
							<div><span class="purple-pattern"><i>backdoorfound</i></span></div>
							<table>
								<tr>
									<td class="green-label">If</td>
									<td>(源设备IP  <span class="pattern-keyword">IN</span>  Devices: Network IPS <strong>OR</strong> (源设备IP  <span class="pattern-keyword">IN</span>  Applications: Network IPS App <strong>AND</strong> 事件类型 <span class="pattern-keyword">CONTAINS</span> Snort-)) <strong>AND</strong> 事件类型 <span class="pattern-keyword">IN</span> EventTypes: Backdoor</td>
								</tr>
								<tr>
									<td class="green-label">WHERE</td>
									<td>源IP = <span class="purple-pattern">backdoorfound</span>.源IP, 目标IP  =  <span class="purple-pattern">backdoorfound</span>.目标IP</td>
								</tr>
								<tr>
									<td class="green-label">GROUP BY</td>
									<td>源IP, 目标IP</td>
								</tr>
							</table>
						</div>
						<!-- /.pattern -->
						<div class="col-xs-12 pattern">
							<div><span class="purple-pattern"><i>backdoorfound</i></span></div>
							<table>
								<tr>
									<td class="green-label">If</td>
									<td>(源设备IP  <span class="pattern-keyword">IN</span>  Devices: Network IPS <strong>OR</strong> (源设备IP  <span class="pattern-keyword">IN</span>  Applications: Network IPS App <strong>AND</strong> 事件类型 <span class="pattern-keyword">CONTAINS</span> Snort-)) <strong>AND</strong> 事件类型 <span class="pattern-keyword">IN</span> EventTypes: Backdoor</td>
								</tr>
								<tr>
									<td class="green-label">WHERE</td>
									<td>源IP = <span class="purple-pattern">backdoorfound</span>.源IP, 目标IP  =  <span class="purple-pattern">backdoorfound</span>.目标IP</td>
								</tr>
								<tr>
									<td class="green-label">GROUP BY</td>
									<td>源IP, 目标IP</td>
								</tr>
							</table>
						</div>
						<!-- /.pattern -->
					</div>
					<div class="col-xs-12">
						<label class="control-label col-xs-12">触发事件属性:</label>
						<div class="col-xs-12">
							事件接收时间, 事件类型, 源IP, 目标IP, IP协议, 源TCP/UDP端口, 目标TCP/UDP端口, 源设备IP, 原始事件日志
						</div>
					</div>
				</div>
				<!-- /.row -->
			</div>
		</div>
	</div>
</div>
<!-- /.col-xs-12 -->


<div class="overlay-frm hide" id="addRuleFrm">
	<div class="col-xs-12">
		<div class="box no-drop">
			<div class="box-header">
				<div class="pull-right">
					<a href="#" class="mr">保存</a><a href="#" class="btn-cancel mr">取消</a>
				</div>
				<div class="box-name">
					<span>添加新规则</span>
				</div>
				<div class="no-move"></div>
			</div>
			<!-- /.box-header -->
			<div class="box-content">
				<form action="#" class="form-horizontal">
					<div class="form-group">
						<label for="ruleName" class="control-label col-sm-2">规则名称：</label>
						<div class="col-sm-6">
							<input type="text" class="form-control" id="ruleName" placeholder="输入规则名称">
						</div>
					</div>
					<!-- /.form-group -->
					<div class="form-group">
						<label for="ruleDesc" class="control-label col-sm-2">描述：</label>
						<div class="col-sm-8">
							<textarea type="text" class="form-control" id="ruleDesc"></textarea>
						</div>
					</div>
					<!-- /.form-group -->
					<div class="form-group">
						<label class="control-label col-sm-2">状态：</label>
						<div class="col-sm-3">
							<div class="btn-group" data-toggle="buttons">
								<label class="btn btn-default active"> 
									<input name="vo.patientGender" type="radio" value="未激活" checked>未激活
								</label>
								<label class="btn btn-default"> 
									<input name="vo.patientGender"type="radio" value="激活的">激活的 
								</label>
							</div>
							<!-- /.btn-group -->
						</div>

						<label class="control-label col-sm-2">告警种类：</label>
						<div class="col-sm-2">
							<select name="alertType" class="form-control" id="alertType">
								<option value="应用">应用</option>
								<option value="环境">环境</option>
								<option value="内部">内部</option>
								<option value="网络">网络</option>
								<option value="服务器">服务器</option>
								<option value="存储">存储</option>
								<option value="系统">系统</option>
								<option value="虚拟化">虚拟化</option>
								<option value="其他">其他</option>
							</select>
						</div>
					</div>
					<!-- /.form-group -->

					<div class="form-group">
						<label for="ruleDesc" class="control-label col-sm-2">严重程度：</label>
						<div class="col-sm-6">
							<select name="criticalLevel" id="criticalLevel" class="form-control level-low">
								<option class="level-low" value="1">1 - LOW</option>
								<option class="level-low" value="2">2 - LOW</option>
								<option class="level-low" value="3">3 - LOW</option>
								<option class="level-low" value="4">4 - LOW</option>
								<option class="level-mid" value="5">5 - MID</option>
								<option class="level-mid" value="6">6 - MID</option>
								<option class="level-mid" value="7">7 - MID</option>
								<option class="level-mid" value="8">8 - MID</option>
								<option class="level-high" value="9">9 - HIGH</option>
								<option class="level-high" value="10">10 - HIGH</option>
							</select>
						</div>
					</div>
					<!-- /.form-group -->

					<div class="form-group">
						<label for="ruleDesc" class="control-label col-sm-2">属性：</label>
						<div class="col-sm-2">
							<select name="alertType" class="form-control" id="alertType">
								<option value="所有">所有</option>
								<option value="可用的">可用的</option>
								<option value="性能">性能</option>
								<option value="修改">修改</option>
								<option value="安全">安全</option>
							</select>
						</div>

						<div class="mt-15 visible-xs clearfix"></div>
						<label for="ruleDesc" class="control-label col-xs-12 col-sm-2">通知频率：</label>
						<div class="col-xs-5 col-sm-2">
							<input type="number" class="form-control" id="informFreq">
						</div>
						<div class="col-xs-5 col-sm-4 pl-0">
							<div class="btn-group" data-toggle="buttons">
								<label class="btn btn-default active"> 
									<input name="informFreqLevel" type="radio" value="min" checked>分钟
								</label>
								<label class="btn btn-default"> 
									<input name="informFreqLevel"type="radio" value="hour">时 
								</label>
							</div>
							<!-- /.btn-group -->
						</div>
					</div>
					<!-- /.form-group -->

					<div class="form-group">
						<label for="ruleDesc" class="control-label col-sm-2">条件：</label>
						<div class="col-sm-10">
							<button id="addSubPtn" class="btn btn-xs btn-default"><span class="glyphicon glyphicon-plus"></span> 添加子模式</button>
							<button id="delSubPth" class="btn btn-xs btn-default"><span class="glyphicon glyphicon-minus"></span> 删除子模式</button>
							<div class="mt-15"><label for="" class="control-label">如果该模式被触发：</label></div>
							<table id="subPatternTable" class="table table-bordered table-condensed">
								<thead>
									<th>操作</th>
									<th>括号</th>
									<th>子模式</th>
									<th>括号</th>
									<th>行</th>
								</thead>
								<tbody>
									<tr class="clause template">
										<td>
											<select class="form-control relation" name="relation">
												<option value="AND">AND</option>
												<option value="OR">OR</option>
											</select>
										</td>
										<td class="left-bracket bracket">
										</td>
										<td>
											<select class="form-control sub-pattern-sel">
											</select>
											<a href="#" class="edit-sp"><span class="glyphicon glyphicon-edit"></span> </a>
										</td>
										<td class="right-bracket bracket">
										</td>
										<td class="row-action">
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
					<!-- /.form-group -->
				</form>
			</div>
			<!-- /.box-content -->
		</div>
		<!-- /.box -->
	</div>
	<!-- /.col-xs-12 -->
</div>
<!-- /#addRuleFrm -->


<div class="overlay-frm hide" id="subPatternFrm">
	<div class="col-xs-12">
		<div class="box no-drop">
			<div class="box-header">
				<div class="pull-right">
					<a href="#" id="saveSubPattern" class="mr">保存</a><a href="#" class="btn-cancel mr">取消</a>
				</div>
				<div class="box-name">
					<span>添加新的子模式</span>
				</div>
				<div class="no-move"></div>
			</div>
			<!-- /.box-header -->
			<div class="box-content clearfix">
				<form action="#" class="form-horizontal">
					<div class="form-group">
						<label for="spName" class="control-label col-sm-2">子模式名称：</label>
						<div class="col-sm-6">
							<input type="text" class="form-control" id="spName" value="filter1" placeholder="输入子模式名称">
							<a href="#" onclick="setUpTest();" class="btn btn-danger">填充测试</a>
						</div>
					</div>
					<!-- /.form-group -->

					<div class="col-xs-12 clearfix">
						<fieldset>
							<legend>过滤：<a href="#" class="pull-right add-row btn btn-default"><span class="glyphicon glyphicon-plus"></span> 添加一行</a></legend>
							<table id="filterTable" data-clause="rule-filter" class="table table-bordered table-condensed mt-15">
								<thead>
									<th>关系</th>
									<th>括号</th>
									<th>属性</th>
									<th>操作</th>
									<th>值</th>
									<th>括号</th>
									<th>行</th>
								</thead>
								<tbody>
									<tr class="clause template">
										<td>
											<select class="form-control relation" name="relation">
												<option value="AND">AND</option>
												<option value="OR">OR</option>
											</select>
										</td>
										<td class="left-bracket bracket">
										</td>
										<td>
											<select class="chosen-sel" name="attribute">
												<option value=""></option>
												<option value="attr1">属性1</option>
												<option value="attr2">属性2</option>
												<option value="attr3">属性3</option>
												<option value="attr1">属性1</option>
												<option value="attr2">属性2属性2属性2属性2属性2属性2</option>
												<option value="attr3">属性3</option>
												<option value="attr1">属性1</option>
												<option value="attr2">属性2</option>
												<option value="attr3">属性3</option>
												<option value="attr1">属性1</option>
												<option value="attr2">属性2</option>
												<option value="attr3">属性3</option>
												<option value="attr1">属性1</option>
												<option value="attr2">属性2</option>
												<option value="attr3">属性3</option>
												<option value="attr1">属性1</option>
												<option value="attr2">属性2</option>
												<option value="attr3">属性3</option>
												<option value="attr1">属性1</option>
												<option value="attr2">属性2</option>
												<option value="attr3">属性3</option>
												<option value="attr1">属性1</option>
												<option value="attr2">属性2</option>
												<option value="attr3">属性3</option>
											</select>
										</td>
										<td>
											<select class="form-control" name="operator">
												<option value=""></option>
												<option value="eq">=</option>
												<option value="ueq">!=</option>
												<option value="gt">&gt;</option>
												<option value="lt">&lt;</option>
												<option value="gte">&gt;=</option>
												<option value="lte">&lt;=</option>
												<option value="between">BETWEEN</option>
												<option value="nbetween">NOT BETWEEN</option>
												<option value="in">IN</option>
												<option value="nin">NOT IN</option>
												<option value="contains">CONTAINS</option>
												<option value="ncontains">NOT CONTAINS</option>
												<option value="is">IS</option>
												<option value="isnot">IS NOT</option>
											</select>
										</td>
										<td>
											<input type="text" class="form-control" name="value">
										</td>
										<td class="right-bracket bracket">
										</td>
										<td class="row-action">
										</td>
									</tr>
								</tbody>
							</table>
						</fieldset>
					</div>
					<!-- /.col-xs-12 -->
					<div class="col-xs-12 clearfix">
						<fieldset>
							<legend>聚合条件：<a href="#" class="pull-right add-row btn btn-default"><span class="glyphicon glyphicon-plus"></span> 添加一行</a></legend>
							<table id="whereTable" data-clause="rule-where" class="table table-bordered table-condensed mt-15">
								<thead>
									<th>关系</th>
									<th>括号</th>
									<th>属性</th>
									<th>操作</th>
									<th>值</th>
									<th>括号</th>
									<th>行</th>
								</thead>
								<tbody>
									<tr class="clause template">
										<td>
											<select class="form-control relation" name="relation">
												<option value="AND">AND</option>
												<option value="OR">OR</option>
											</select>
										</td>
										<td class="left-bracket bracket">
										</td>
										<td>
											<select class="chosen-sel" name="attribute">
												<option value=""></option>
												<option value="attr1">属性1</option>
												<option value="attr2">属性2</option>
												<option value="attr3">属性3</option>
											</select>
										</td>
										<td>
											<select class="form-control" name="operator">
												<option value=""></option>
												<option value="eq">=</option>
												<option value="ueq">!=</option>
												<option value="gt">&gt;</option>
												<option value="lt">&lt;</option>
												<option value="gte">&gt;=</option>
												<option value="lte">&lt;=</option>
												<option value="between">BETWEEN</option>
												<option value="nbetween">NOT BETWEEN</option>
												<option value="in">IN</option>
												<option value="nin">NOT IN</option>
												<option value="contains">CONTAINS</option>
												<option value="ncontains">NOT CONTAINS</option>
												<option value="is">IS</option>
												<option value="isnot">IS NOT</option>
											</select>
										</td>
										<td>
											<input type="text" class="form-control" name="value">
										</td>
										<td class="right-bracket bracket">
										</td>
										<td class="row-action">
										</td>
									</tr>
								</tbody>
							</table>
						</fieldset>
					</div>
					<!-- /.col-xs-12 -->

					<div class="col-xs-6 clearfix">
						<fieldset>
							<legend>分组方式：<a href="#" class="pull-right add-row btn btn-default"><span class="glyphicon glyphicon-plus"></span> 添加一行</a></legend>
							<table id="groupByTable" data-clause="rule-group" class="table table-bordered table-condensed mt-15">
								<thead>
									<th>属性</th>
									<th>行</th>
								</thead>
								<tbody>
									<tr class="clause template">
										<td>
											<select class="chosen-sel" name="attribute">
												<option value=""></option>
												<option value="attr1">属性1</option>
												<option value="attr2">属性2</option>
												<option value="attr3">属性3</option>
											</select>
										</td>
										<td class="row-action">
										</td>
									</tr>
								</tbody>
							</table>
						</fieldset>
					</div>
					<!-- /.col-xs-6 -->
				</form>
			</div>
			<!-- /.box-content -->
		</div>
		<!-- /.box -->
	</div>
	<!-- /.col-xs-12 -->
</div>
<!-- /#subPatternFrm -->

</div>
<!-- /.row -->


<!-- evalModal -->
<div class="modal fade" id="evalModal" tabindex="-1" role="dialog" aria-labelledby="evalModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
				<h5 class="modal-title" id="evalModalLabel">Eval</h5>
			</div>
			<div class="modal-body clearfix">
				<div class="row mb">
					<div class="col-xs-12">
						<input type="text" id="evalStr" class="form-control" name="eval" placeholder="表达式">
					</div>
				</div>
				<!-- /.row mb -->
				<div class="row mb">
					<div class="col-sm-4">
						<label for="evalFunc" class="control-label">添加方法</label>		
						<select id="evalFunc" class="chosen-sel">
							<option value=""></option>
							<option value="func1">func1</option>
							<option value="func2">func2</option>
							<option value="func3">func3</option>
						</select>
						<a href="#" class="btn btn-xs add-again"><span class="glyphicon glyphicon-plus"></span></a>
					</div>
					<!-- /.col-sm-4 -->
					<div class="col-sm-4">
						<label for="evalEvent" class="control-label">添加属性</label>
						<select id="evalEvent" class="chosen-sel">
							<option value=""></option>
							<option value="attr1">属性1</option>
							<option value="attr2">属性2</option>
							<option value="attr3">属性3</option>
						</select>
						<a href="#" class="btn btn-xs add-again"><span class="glyphicon glyphicon-plus"></span></a>						
					</div>
					<!-- /.col-sm-4 -->
					<div class="col-sm-4">
						<label for="evalCMDB" class="control-label">添加CMDB属性</label>
						<select id="evalCMDB" class="chosen-sel">
							<option value=""></option>
							<option value="CMDB1">CMDB1</option>
							<option value="CMDB2">CMDB2</option>
							<option value="CMDB3">CMDB3</option>
						</select>
						<a href="#" class="btn btn-xs add-again"><span class="glyphicon glyphicon-plus"></span></a>
					</div>
					<!-- /.col-sm-4 -->
				</div>
				<!-- /.row mb -->
				<div class="row mb">
					<div class="col-sm-6">
						<a href="#" class="pull-right btn btn-default" data-dismiss="modal">取 消</a>
						<a href="#" id="evalSubmit" class="pull-right mr eval-btn btn btn-primary">确 定</a>
					</div>
					<div class="col-sm-6">
						<a href="#" id="evalReset" class="btn btn-default">清 理</a>
					</div>
				</div>
				<!-- /.form-group -->
			</div>
		</div>
	</div>
</div>


<!-- Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-sm">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
				<h5 class="modal-title" id="errorModalLabel">Error</h5>
			</div>
			<div class="modal-body">

			</div>
		</div>
	</div>
</div>


<script type="text/javascript">
	var __rule = null;
	/**
	 * 规则表现函数
	 * @type {Object}
	 */
	var ruleFuncs = {
		currentSel: null,
		selArr: [],
		addSubPattern: function(sp) {
			console.log('addSp');
			if (!__rule.addSubPattern(sp))
				return false;
			this.selArr.push(sp.name);
			this.selectSubPattern(sp.name);
			return true;
		},
		/**
		 * [addSubPatternTr description]
		 * @param {[type]} trHandle [description]
		 */
		addSubPatternTr: function(trHandle) {
			var $template = $('#subPatternTable .template');
			var $target = trHandle ? $(trHandle).next('tr') : $template;
			console.log('addTr');

			var $newTr = $template.clone(true, true).removeClass('template').insertBefore($target);
			if (this.selArr.length <= 0) {
				spFuncs.editSubPattern({target: $('.edit-sp', $newTr)});
			}
			return $newTr;
		},
		selectSubPattern: function(name) {
			if (!name) return;
			$('<option>').text(name).val(name).appendTo(this.currentSel);
			$(this.currentSel).val(name);
		}
	};

	/**
	 * 子模式表现函数
	 * @type {Object}
	 */
	var spFuncs = {
		editSubPattern: function(event) {
			ruleFuncs.currentSel = $(event.target).closest('td').children('select');
			var _name = $(ruleFuncs.currentSel).val();
			if (_name) {
				this.modSubPattern(_name);
			} else {
				$('#spName', '#subPatternFrm').val(name || __rule.getNewSpName());
			}
			showOverlayFrm('#subPatternFrm');
		},
		modSubPattern: function(name) {
			var _sp = __rule.getSpByName(name);
			if (!_sp) {
				showAlert(true, '获取子模式失败！', 'danger', false, 2000);
				return;
			};
			clauseFunc.setUpByJSON(_sp, '#spName', '#filterTable', '#whereTable', '#groupByTable');
		},
		clearSubPattern: function(name) {
			$('#spName', '#subPatternFrm').val(name || '');
			$('.template', '#subPatternFrm').siblings('tr').remove();
		}
	};
	$(document).ready(function() {
		LoadByoneTableScripts(tableReady);
		LoadChosenScript();
		LoadClauseScript();
		WinMove();
		tableContextMenu('#ruleTable');
		ruleCheck(ruleCheckCallback);
		$('#criticalLevel').change(function(event) {
			/* Act on the event */
			changeSelectColor(this);
		});
		$('#addSubPtn').click(function(event) {
			/* Act on the event */
			ruleFuncs.addSubPatternTr();
		});

		//保存子模式
		$('#saveSubPattern').click(function(event) {
			/* Act on the event */
			var _name = $('#spName').val();
			if (!_name) {
				Clause.prototype.showError('子模式名不能为空');
				return false;
			};
			var _newSP = new Clause(_name);
			if (!_newSP.loadFromForm('#filterTable', '#whereTable', '#groupByTable')) {
				delete _newSP;
				return false;
			}
			if (!ruleFuncs.addSubPattern(_newSP)) {
				console.log('addSp');
				Clause.prototype.showError('子模式名"' + _newSP + '"已存在');
				return false;
			};
			hideOverlayFrm('#subPatternFrm');
			/*console.log(_newSP.serialize());*/
		});
		console.log(spFuncs);

		//编辑子模式
		$('.edit-sp').click($.proxy(spFuncs.editSubPattern, spFuncs));
	});


	function tableReady() {
		$('#ruleTable').byoneTable({
			ajax: "queryAllRules.do",
			"sort": ["ruleName", 'asc'],
			/*"rightClick": {
				targetMenu: "#ruleDropMenu"
			},*/
			dataId: "id",
			"pagination": true,
			"searchHandle": "#ruleSearch",
			"columns": [{
				"class": "ruleStatus",
				"data": "ruleStatus",
				"sortable": false,
				"defaultContent": '<input type="checkbox" class="rule-state-check" {1}>' //checked | null
			}, {
				"class": "ruleName",
				"data": "ruleName"
			}, {
				"class": "source",
				"data": "source"
			}, {
				"class": "description",
				"sortable": false,
				"data": "description"
			}]
		});
		tableTrClick('#ruleTable', function(ruleId) {
			console.log(ruleId + ' clicked');
		});
	}

	/**
	 * 等级颜色
	 * @param  {String | Jquery Object} placeholder 容器
	 */
	function changeSelectColor(placeholder) {
		var $placeholder = $(placeholder);
		var level = $placeholder.val();
		if ((level -= 4) < 0) {
			$placeholder[0].className = 'form-control level-low';
			return;
		};
		if ((level -= 4) < 0) {
			$placeholder[0].className = 'form-control level-mid';
			return;
		};
		$placeholder[0].className = 'form-control level-high';
	}

	/*新增规则*/
	function addRule() {
		__rule = new Rule();
		showOverlayFrm('#addRuleFrm');
	}

	function modRule(id) {
		//fillForm(id);
		showOverlayFrm('#addRuleFrm');
	}

	/**
	 * 条件类
	 */
	function Rule() {
		this.subPatterns = {};
		this.addSubPattern = function(sp) {
			console.log('addSp');
			if (this.subPatterns[sp.name]) //子模式名重复
				return false;
			this.subPatterns[sp.name] = sp;
			return true;
		};
		/**
		 * 返回当前子模式个数
		 * @return {[type]} [description]
		 */
		this.getSPLength = function() {
			var _index = 0;
			for (attr in this.subPatterns) {
				++_index;
			}
			return _index;
		};
		this.getNewSpName = function() {
			return 'SubPattern' + this.getSPLength();
		};
		this.getSpByName = function(name) {
			return this.subPatterns[name] || null;
		}
	}



	/**
	 * 规则状态变更回调函数
	 * @param  {[type]}  id        [description]
	 * @param  {[type]}  ruleName  [description]
	 * @param  {Boolean} isChecked [description]
	 * @return {boolean}            [description]
	 */
	function ruleCheckCallback(id, ruleName, isChecked) {
		var _check = isChecked ? '启用' : '停用';
		if (!confirm('确定要' + _check + '规则"' + ruleName + '"吗？')) {
			return false;
		}
		var $checkbox = $(this);
		//console.log($(this));
		showAlert(true, '状态更改中...', 'info', true);
		$.get('changeStatus.do', {
			id: id,
			ruleStatus: isChecked ? 'checked' : 'null'
		}, function(data) {
			/*optional stuff to do after success */
			if ($.trim(data) === 'success') {
				showAlert(true, '状态更改成功！', 'success', false, 2000);
			} else {
				showAlert(true, '状态更改失败。', '', false, 2000);
				isChecked = !isChecked;
			}
			if (isChecked) {
				$checkbox.prop('checked', true);
			} else {
				$checkbox.prop('checked', false);
			}
			/*setTimeout(function() {
				showAlert(false);
			}, 2000);*/
		});
		return true;
	}



	function setUpTest() {
		/*test*/
		var _clause = {
			name: 'test',
			filters: [{
				attribute: "attr3",
				leftBracket: 2,
				operator: "ueq",
				rightBracket: 0,
				value: "1"
			},{
				relation: "AND",
				attribute: "attr2",
				leftBracket: 0,
				operator: "eq",
				rightBracket: 1,
				value: "13"
			},{
				relation: "OR",
				attribute: "attr1",
				leftBracket: 2,
				operator: "ueq",
				rightBracket: 1,
				value: "1"
			}],
			where: [{
				attribute: "attr3",
				leftBracket: 2,
				operator: "ueq",
				rightBracket: 0,
				value: "1"
			},{
				relation: "AND",
				attribute: "attr2",
				leftBracket: 0,
				operator: "eq",
				rightBracket: 1,
				value: "13"
			},{
				relation: "AND",
				attribute: "attr1",
				leftBracket: 2,
				operator: "ueq",
				rightBracket: 0,
				value: "1"
			}],
			groupBys: [{
				attribute: "attr1"
			}, {
				attribute: "attr2"
			}]
		};
		clauseFunc.setUpByJSON(_clause, '#spName', '#filterTable', '#whereTable', '#groupByTable');
		/*test*/
	}
</script>