<div class="row">
	<div id="breadcrumb" class="col-xs-12">
		<ol class="breadcrumb pull-left">
			<li><a class="ajax-link" href="./ajax/dashboard.html">首页</a></li>
			<li><a href="#">系统</a></li>
			<li><a href="#">用户管理</a></li>
		</ol>
	</div>
	<!-- /#breadcrumb -->
</div>
<!-- /.row -->

<div class="row">
	<div class="col-xs-12">
		<div class="box no-drop">
			<div class="box-header">
				<div class="box-name">
					<span>用户</span>
				</div>
				<div class="box-icons">
					<a class="collapse-link">
						<i class="fa fa-chevron-up"></i>
					</a>
				<!-- <a class="expand-link">
					<i class="fa fa-expand"></i>
				</a> -->
			</div>
			<div class="no-move"></div>
		</div>
		<div class="box-content clearfix">
			<div class="col-xs-6 mb-half">
				<input type="text" class="form-control" id="userSearch" placeholder="输入查询条件">
			</div>
			<div class="col-xs-6 mb-half" id="userActions">
				<!-- test 添加的onclik -->
				<a href="#" class="btn btn-default" onclick="addUser()"><span class="glyphicon glyphicon-plus"></span> 添加</a>
				<a href="#" class="btn btn-default rely-on-table" data-func="fillForm('{1}')" disabled><span class="glyphicon glyphicon-trash"></span> 编辑</a>
				<a href="#" class="btn btn-default rely-on-table" data-func="delUser('{1}')" disabled><span class="glyphicon glyphicon-trash"></span> 删除</a>
			</div>
			<table id="userTable" class="table table-condensed table-striped  table-block table-hover user-table byoneTable" action-handle="#userActions">
				<thead>
					<tr>
						<th>名称</th>
						<th>全名</th>
						<th>系统角色</th>
						<th>LDAP账户控制</th>
						<th>工作头衔</th>
						<th>工作电话</th>					
						<th>移动电话</th>					
						<th>Email</th>					
						<th>组织</th>					
					</tr>
				</thead>
				<tbody>
				</tbody>
			</table>
			
			<!-- /.col-sm-6 -->
		</div>
		<!-- /.box-content -->
	</div>
	<!-- /.box -->
</div>
<!-- /.col-xs-12 -->

<div class="col-xs-12">
	<div id="userFrame" class="box no-drop">
		<div class="box-header">
			<div class="box-name">
				<span id="userFrameTitle">用户信息维护</span>
			</div>
			<div class="box-icons">
				<a class="collapse-link">
					<i class="fa fa-chevron-up"></i>
				</a>
			</div>
			<div class="no-move"></div>
		</div>
		<div class="box-content clearfix">
			<form id="userForm" class="form-horizontal">
			
				<div class="col-sm-6">
				<!-- 传入用户id -->
					<input type="hidden" data-name="id" name="id" id="id" class="form-control" >
					<div class="form-group">
						<label for="userName" class="control-label col-xs-4 col-sm-3 no-empty">用户名：</label>
						<div class="col-xs-8">
							<input type="text" data-name="userName" name="userName" id="userName" class="form-control" placeholder="由5-20个字母、数字和下划线组成" required maxlength="20" minlength="5" pattern="^\w*$">
						</div>
					</div>
					<div class="form-group">
						<label for="fullName" class="control-label col-xs-4 col-sm-3 no-empty">全名：</label>
						<div class="col-xs-8">
							<input type="text" data-name="fullName" name="fullName" id="fullName" class="form-control" required maxlength="20" minlength="2">
						</div>
					</div>
					<div class="form-group">
						<label for="position" class="control-label col-xs-4 col-sm-3">职位：</label>
						<div class="col-xs-8">
							<input type="text" data-name="position" name="position" id="position" class="form-control">
						</div>
					</div>
					<div class="form-group">
						<label for="company" class="control-label col-xs-4 col-sm-3">公司：</label>
						<div class="col-xs-8">
							<input type="text" data-name="company" name="company" id="company" class="form-control">
						</div>
					</div>
					<div class="form-group">
						<label for="description" class="control-label col-xs-4 col-sm-3">描述：</label>
						<div class="col-xs-8">
							<textarea name="description" class="form-control" data-name="description" id="description" rows="2" maxlength="500"></textarea>
						</div>
					</div>
					<div class="form-group">
						<label for="" class="control-label col-xs-4 col-sm-3">账号有效：</label>
						<div class="col-xs-8">
							<label class="radio-inline">
								<input type="radio" data-name="avilability" name="accountValid" value="1" checked> 是
							</label>
							<label class="radio-inline">
								<input type="radio" data-name="avilability" name="accountValid" value="0"> 否
							</label>
						</div>
					</div>
					<div class="form-group">
						<label for="domainName" class="control-label col-xs-4 col-sm-3">域名：</label>
						<div class="col-xs-8">
							<input type="text" data-name="domainName" name="domainName" id="domainName" class="form-control">
						</div>
					</div>
					<div class="form-group">
						<label for="dn" class="control-label col-xs-4 col-sm-3">DN：</label>
						<div class="col-xs-8">
							<input type="text" data-name="dn" name="dn" id="dn" class="form-control">
						</div>
					</div>
					<div class="form-group">
						<label for="sessionTimeout" class="control-label col-xs-4 col-sm-3">会话超时：</label>
						<div class="col-xs-8">
							<input type="number" data-name="sessionTimeout" name="sessionTimeout" id="sessionTimeout" class="form-control">
							(分钟)
						</div>
					</div>
					<div class="form-group">
						<label for="userLock" class="control-label col-xs-4 col-sm-3">用户锁定：</label>
						<div class="col-xs-8">
							<input type="number" data-name="userLock" name="userLock" id="userLock" class="form-control">
							(分钟)
						</div>
					</div>
					<div class="form-group">
						<label for="pwResetDay" class="control-label col-xs-4 col-sm-3">密码重置：</label>
						<div class="col-xs-8">
							<input type="number" data-name="pwResetDay" name="pwResetDay" id="pwResetDay" class="form-control">
							(天数)
						</div>
					</div>
				</div>
				<div class="col-sm-6">
					<div class="form-group">
						<label for="" class="control-label col-xs-4 col-sm-3">系统管理员：</label>
						<div class="col-xs-8">
							<label class="radio-inline">
								<input type="radio" data-name="isAdmin" name="isAdmin" value="1" checked> 是
							</label>
							<label class="radio-inline">
								<input type="radio" data-name="isAdmin" name="isAdmin" value="0"> 否
							</label>
						</div>
					</div>
					<div class="form-group">
						<label for="" class="control-label col-xs-4 col-sm-3">密码：</label>
						<div class="col-xs-8">
							<label class="radio-inline">
								<input type="radio" data-name="domain" name="domain" value="Local" checked> Local
							</label>
							<label class="radio-inline">
								<input type="radio" data-name="domain" name="domain" value="External"> External
							</label>
						</div>
					</div>
					<div class="form-group">
						<label for="password" class="control-label col-xs-4 col-sm-3 no-empty">密码：</label>
						<div class="col-xs-8">
							<input type="password" data-name="password" name="password" required id="password" class="form-control">
						</div>
					</div>
					<div class="form-group">
						<label for="cfmpwd" class="control-label col-xs-4 col-sm-3 no-empty">确认密码：</label>
						<div class="col-xs-8">
							<input type="password" id="cfmpwd" data-name="password" class="form-control" required>
						</div>
					</div>
					<div class="form-group">
						<label for="roleSel" class="control-label col-xs-4 col-sm-3 no-empty">角色：</label>
						<div class="col-xs-8">
							<select data-name="roleId" name="roleId" class="form-control" id="roleSel" required>
							</select>
						</div>
					</div>
					<div class="form-group">
						<label for="workPhone" class="control-label col-xs-4 col-sm-3">工作电话：</label>
						<div class="col-xs-8">
							<input type="text" data-name="workPhone" name="workPhone" id="workPhone" class="form-control">
						</div>
					</div>
					<div class="form-group">
						<label for="mobilePhone" class="control-label col-xs-4 col-sm-3">移动电话：</label>
						<div class="col-xs-8">
							<input type="text" data-name="mobilePhone" name="mobilePhone" id="mobilePhone" class="form-control">
						</div>
					</div>
					<div class="form-group">
						<label for="familyPhone" class="control-label col-xs-4 col-sm-3">家庭电话：</label>
						<div class="col-xs-8">
							<input type="text" data-name="familyPhone" name="familyPhone" id="familyPhone" class="form-control">
						</div>
					</div>
					<div class="form-group">
						<label for="email" class="control-label col-xs-4 col-sm-3">Email：</label>
						<div class="col-xs-8">
							<input type="email" data-name="email" name="email" id="email" class="form-control">
						</div>
					</div>
					<div class="form-group">
						<label for="address " class="control-label col-xs-4 col-sm-3">地址：</label>
						<div class="col-xs-8">
							<textarea name="address " class="form-control" data-name="address " id="address " rows="2" maxlength="200"></textarea>
						</div>
					</div>
					<div class="form-group">
						<div class="col-xs-8 col-xs-offset-2">
							<input type="submit" class="btn btn-primary pull-right mr" value="提 交">
						</div>
					</div>
				</div>
			</form>
			<div class="zoom loading">
				<div class="spinner"></div>
			</div>
		</div>
		<!-- /.box-content -->
	</div>
	<!-- /.box -->
</div>
<!-- /.col-xs-12 -->

</div>
<!-- /.row -->


<script type="text/javascript">

	function tableReady() {
		$('#userTable').byoneTable({
			ajax: "queryUsersByOrg.do",
			"sort": ["userName", 'asc'],
			/*"rightClick": {
				targetMenu: "#ruleDropMenu"
			},*/
			dataId: "id",
			"pagination": true,
			"searchHandle": "#userSearch",
			"columns": [{
				"data": "userName"
			},{
				"data": "fullName"
			},{
				"data": "roleName"
			},{
				"data": "ldapControl"
			},{
				"data": "position"
			},{
				"sortable": false,
				"data": "workPhone"
			},{
				"sortable": false,
				"data": "mobilePhone"
			},{
				"sortable": false,
				"data": "email"
			},{
				"data": "orgName"
			}]
		});
		tableTrClick('#userTable', fillForm);
	}

	function getRoles() {
		$.get('queryAllRole.do', function(data) {
			var _roleList = data.roleVoList;
			window.localStorage && window.localStorage.setItem('roleList', JSON.stringify(_roleList));
			var $roleSel =$('#roleSel');
			for (var i = 0; i < _roleList.length; i++) {
				var _role = _roleList[i];
				$('<option value="'+_role.id+'">'+_role.roleName+'</option>').appendTo($roleSel)
			};
		});
	}

	/**
	 * 单击用户列表后显示详细信息
	 * @param  {[String]} id [用户ID]
	 */
	 function fillForm(id) {
	 	resetForm($('#userForm').attr('action', 'updateUser.do'));
	 	var $loading = $('#userFrame .loading').show();
	 	$('#userFrameTitle').text('用户信息维护');
	 	$.get("queryUserById.do", {
	 		"id": id
	 	}, function(data) {
	 		fillInfo(data.userVo, '#userForm');
	 		$loading.hide();
	 	});
	 }

	 function addUser() {
	 	$('#userTable .active').removeClass('active');
	 	$('#userFrameTitle').text('添加用户');
	 	/*重置form*/
	 	resetForm($('#userForm').attr('action', 'addUser.do'));
	 }
	 function delUser(id) {
	 	if(!confirm('您确定要删除该用户吗？')) {
	 		return;
	 	}
	 	showAlert(true, "提交中...", 'info', true);
	 	$.get('deleteUser.do', {
	 		'id': id
	 	}, function(data) {
	 		if (data === 'operateSuccess') {
	 			showAlert(true, "删除成功", 'success', false, 500, function() {
	 				LoadAjaxContent(window.location.hash.substring(1), true);
	 			});
	 		}
	 	});
	 }

	 function resetForm(placeholder) {
	 	$(placeholder).data('bootstrapValidator').resetForm(true).$form[0].reset();
	 	$('textarea', placeholder).text('');
	 	$(':checked', placeholder).click();
	 	return $(placeholder);
	 }

	 function formValidate() {
	 	$('#userForm').bootstrapValidator({
	 		feedbackIcons: {
	 			valid: 'glyphicon glyphicon-ok',
	 			invalid: 'glyphicon glyphicon-remove',
	 			validating: 'glyphicon glyphicon-refresh'
	 		},
	 		fields: {
	 			'cfmpwd': {
	 				selector: '#cfmpwd',
	 				validators: {
	 					notEmpty: {},
	 					callback: {
	 						message: '两次密码输入须一致',
	 						callback: function(value, validator) {
	 							return value == $('#password').val();
	 						}
	 					}
	 				}
	 			},
	 			'workPhone': {
	 				validators: {
	 					regexp: {
	 						regexp: /^(1[3|4|5|8][0-9]\d{8})|(([0\+]\d{2,3}-)?(0\d{2,3})-)?(\d{7,8})(-(\d{3,}))?$/,
	 						message: '电话应为手机号或[区号-]座机号'
	 					}
	 				}
	 			},
	 			'mobilePhone': {
	 				validators: {
	 					regexp: {
	 						regexp: /^(1[3|4|5|8][0-9]\d{8})|(([0\+]\d{2,3}-)?(0\d{2,3})-)?(\d{7,8})(-(\d{3,}))?$/,
	 						message: '电话应为手机号或[区号-]座机号'
	 					}
	 				}
	 			},
	 			'familyPhone': {
	 				validators: {
	 					regexp: {
	 						regexp: /^(1[3|4|5|8][0-9]\d{8})|(([0\+]\d{2,3}-)?(0\d{2,3})-)?(\d{7,8})(-(\d{3,}))?$/,
	 						message: '电话应为手机号或[区号-]座机号'
	 					}
	 				}
	 			}
	 		}
	 	}).on('success.form.bv', function(e) {
	 		e.preventDefault();
	 		showAlert(true, '提交中...', 'info', true);
	 		//debugger
	 		//alert('submit');
	 		$.ajax({
	 			url: $(this).attr('action'),
	 			type: "GET",
	 			datatype: "json",
	 			contentType: 'application/json;charset=UTF-8',
	 			data: $(this).serialize(),
	 			success: function(data) {
	 				/*optional stuff to do after success */
	 				console.log(data);
	 				if (data!='error') {
	 					showAlert(true, '提交成功！', 'success', false, 500, function() {
	 						LoadAjaxContent(window.location.hash.substring(1), true);
	 					});
	 				} else {
	 					showAlert(true, '提交失败，请联系管理员。', 'danger', false, 2000);
	 				}
	 			},
	 			error: function() {
	 				showAlert(true, '提交失败，请重试。', 'danger', false, 2000);
	 			}
	 		});
	 	});
	 	// .on('success.form.bv', function(e) {
	 	// 	e.preventDefault();
	 	// 	debugger
	 	// 	
	 	// });
}

$(document).ready(function() {
	LoadByoneTableScripts(tableReady);
	LoadBootstrapValidatorScript(formValidate);
	getRoles();
});
</script>