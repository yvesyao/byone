<div class="row">
	<div id="breadcrumb" class="col-xs-12">
		<ol class="breadcrumb pull-left">
			<li><a class="ajax-link" href="./ajax/dashboard.html">首页</a></li>
			<li><a href="#">安全管理</a></li>
			<li><a href="#">告警通知策略</a></li>
		</ol>
	</div>
	<!-- /#breadcrumb -->
</div>
<!-- /.row -->

<div class="row">

	<div class="col-xs-12">
		<div class="box no-drop">
			<div class="box-header">
				<div class="box-name">
					<span>告警通知策略：</span>
				</div>
				<div class="box-icons">
					<a class="collapse-link">
						<i class="fa fa-chevron-up"></i>
					</a>
					<!-- <a class="expand-link">
						<i class="fa fa-expand"></i>
					</a> -->
				</div>
				<div class="no-move"></div>
			</div>
			<div class="box-content clearfix">
				<div class="row">
					<div class="col-sm-6 mb-half" id="noticeActions">
						<a href="#" class="btn btn-primary" onclick="addNotice()">添加
						</a>
						<a href="#" class="btn btn-primary rely-on-table" disabled data-func="modNotice('{1}')">修改
						</a>
						<a href="#" class="btn btn-primary rely-on-table" disabled data-func="delNotice('{1}')">删除
						</a>
					</div>
					<div class="col-sm-6 mb-half">
						<input type="text" class="form-control" id="noticeSearch" placeholder="输入查询条件">
					</div>
				</div>
				<table id="noticeTable" class="table table-condensed table-striped table-bordered table-block table-hover byoneTable" action-handle="#noticeActions">
					<thead>
						<tr>
							<th>策略</th>
							<th>可用</th>
							<th>安全级别</th>
							<th>规则</th>
							<th>时间段</th>
							<th>动作</th>
							<th>备注</th>
						</tr>
					</thead>
					<tbody>
					</tbody>
				</table>

			</div>
			<!-- /.box-content -->
		</div>
		<!-- /.box -->
	</div>
	<!-- /.col-xs-12 -->

</div>
<!-- /.row -->


<!-- Modal -->
<div class="modal fade" id="noticeModal" tabindex="-1" role="dialog" data-backdrop="static" aria-labelledby="noticeModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
				<h5 class="modal-title" id="noticeModalLabel">通知策略</h5>
			</div>
			<form action="#" id="noticeForm" class="form-horizontal">
				<div class="modal-body">
					<div class="form-group">
						<label for="" class="control-label col-xs-4">可用性：</label>
						<div class="col-xs-7">
							<label class="radio-inline">
								<input type="radio" data-name="usability" name="usability" value="1" checked> 启用
							</label>
							<label class="radio-inline">
								<input type="radio" data-name="usability" name="usability" value="0"> 禁用
							</label>
							<input type="hidden" data-name="id" name="id">
						</div>
					</div>
					<div class="form-group">
						<label for="" class="control-label col-xs-4">严重级别：</label>
						<div class="col-xs-7">
							<label class="checkbox-inline">
								<input type="checkbox" data-name="safeLevel" name="safeLevel" id="inlineCheckbox1" value="1"> 低
							</label>
							<label class="checkbox-inline">
								<input type="checkbox" data-name="safeLevel" name="safeLevel" id="inlineCheckbox2" value="2"> 中
							</label>
							<label class="checkbox-inline">
								<input type="checkbox" data-name="safeLevel" name="safeLevel" id="inlineCheckbox3" value="4"> 高
							</label>
						</div>
					</div>
					<div class="form-group">
						<label for="" class="control-label col-xs-4">规则：</label>
						<div class="col-xs-7">
							<select id="ruleSel" data-name="ruleIds" name="ruleIds" class="form-control" multiple>
							</select>
						</div>
					</div>
					<div class="form-group">
						<label for="" class="control-label col-xs-4">时间段：</label>
						<div class="col-xs-7">
							<div class="col-xs-6 no-padding">
								<input type="text" id="startTime" data-name="startTime" name="startTime" class="date-picker form-control">
							</div>
							<div class="col-xs-6 no-padding">
								<input type="text" data-name="endTime" name="endTime" class="date-picker form-control">
							</div>
						</div>
					</div>
					<div class="form-group">
						<label for="" class="control-label col-xs-4">邮箱：</label>
						<div class="col-xs-7">
							<input type="text" data-name="actionEmail" name="actionEmail" class="form-control">
						</div>
					</div>
					<div class="form-group">
						<label for="" class="control-label col-xs-4">备注：</label>
						<div class="col-xs-7">
							<textarea data-name="remarks" name="remarks" class="form-control"></textarea>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="submit" class="btn btn-default">保 存</button>
					<button class="btn btn-primary" data-dismiss="modal">取 消</button>
				</div>
			</form>
		</div>
	</div>
</div>
<!-- /.modal -->

<script type="text/javascript">
	var __ruleList = {};
	function tableReady() {
		$('#noticeTable').byoneTable({
			ajax: "queryAllIncidentPolicy.do",
			"sort": ["id", 'asc'],
			dataId: "id",
			"pagination": true,
			"searchHandle": "#noticeSearch",
			"columns": [{
				"data": "id"
			},{
				"data": "usability",
				format: function(data) {
					if (data == 1) {
						return '<span class="glyphicon glyphicon-ok" style="color: green;"></span>';
					} else {
						return '<span class="glyphicon glyphicon-remove" style="color: red;"></span>';
					}
				}
			},{
				"data": "safeLevel",
				format: formatLevel
			},{
				"data": "ruleNames",
				"sortable": false,
				format: function(data) {
					return data.join(',');
				}
			},{
				"data": "time",
				"sortable": false
			},{
				"data": "actionEmail"
			},{
				"data": "remarks",
				"sortable": false
			}]
		});

		function formatLevel(data) {
			var _levelList = {
				1: '<span class="level-low">LOW</span>',
				2: '<span class="level-mid">MID</span>',
				4: '<span class="level-high">HIGH</span>'
			}, _result='';
			for (var i = 0; i < data.length; i++) {
				_result += _levelList[data[i]] + ' ';
			};
			return _result;
		}

		tableTrClick('#noticeTable');
	}

	function addNotice(noticeId) {
		$('#noticeModal').modal('show');
		$('#noticeForm').attr('action', 'insertIncidentPolicy.do').find(':text,textarea').val('');
		$('#ruleSel').children('option:selected').removeAttr('selected').end().trigger("chosen:updated");
	}

	function delNotice(noticeId) {
		if (confirm('您确定要删除该条信息吗？')) {
			showAlert(true, '删除中...', 'info', true);
			$.get('deleteIncidentPolicy.do', {
				id: noticeId
			}, function(data) {
				showAlert(true, "删除成功", 'success', false, 800, function() {
					LoadAjaxContent(window.location.hash.substring(1), true);
				});
			});
		}
	}


	function modNotice(noticeId) {
		console.log(noticeId + ' clicked');
		$.get("queryIncidentPolicyById.do", {
			"id": noticeId
		}, function(data) {
			console.log(data);
			fillInfo(data, '#noticeForm', {
				startTime: fillDate,
				endTime: fillDate,
				ruleIds: function(elem, ruleIds) {
					$options = $('option', elem);
					$options.filter(':selected').removeAttr('selected');
					if (!ruleIds) {
						$(elem).trigger("chosen:updated");
						return;
					}
					for (var i = 0; i < ruleIds.length; i++) {
						$options.filter('[value="' + ruleIds[i] + '"]').attr('selected', 'selected');
					};
					$(elem).trigger("chosen:updated");
				},
				safeLevel: function(elem, levelList) {
					var $level = $('[name="safeLevel"]').removeAttr('checked').prop('checked', false);
					for (var i = 0; i < levelList.length; i++) {
						$level.filter('[value="' + levelList[i] + '"]').click();
					};
				},
				usability: function(elem, val) {
					$(elem).filter('[value="' + val + '"]').click();
				}
			});
			$('#noticeForm').attr('action', 'updateIncidentPolicy.do');
			$('#noticeModal').modal('show');
		});

		function fillDate(elem, millSeconds) {
			$(elem).val(formatDate(millSeconds));
		}

	}


function formatDate(millSeconds) {
	var _date = new Date(millSeconds);
	return _date.getFullYear() + '-' + (_date.getMonth() + 1) + '-' + _date.getDate();
}

function AllTimePickers() {
	$('.date-picker').datetimepicker({
		timeFormat: "HH:00",
		dateFormat: "yy-mm-dd"
	});
}

function formValidate() {
	$('#noticeForm').bootstrapValidator({
		feedbackIcons: {
			valid: 'glyphicon glyphicon-ok',
			invalid: 'glyphicon glyphicon-remove',
			validating: 'glyphicon glyphicon-refresh'
		},
		fields: {
			'safeLevel': {
				validators: {
					notEmpty: {
						message: "至少选择一种严重级别"
					}
				}
			},
			'ruleIds': {
				validators: {
					notEmpty: {
						message: "至少选择一种规则"
					}
				}
			},
			'startTime': {
				validators: {
					notEmpty: {
						notEmpty: "时间不能为空"
					}
				}
			},
			'endTime': {
				validators: {
					notEmpty: {
						notEmpty: "时间不能为空"
					}
				}
			},
			'actionEmail': {
				validators: {
					notEmpty: {
						notEmpty: "请输入email"
					},
					emailAddress: {
						message: '请输入正确格式的email'
					}
				}
			}
		}
	}).on('success.form.bv', function(e) {
		e.preventDefault();
		showAlert(true, '提交中...', 'info', true);
		var _formList = $(this).serializeArray(), 
		_result = {
			safeLevel: [],
			rules: []
		};
		for (var i = 0; i < _formList.length; i++) {
			var _item = _formList[i];
			switch(_item.name) {
				case 'ruleIds':
				_result.rules.push({
					'id': _item.value,
					'ruleName': __ruleList[parseInt(_item.value)]
				})
				break;
				case 'safeLevel':
				_result.safeLevel.push(parseInt(_item.value));
				break;
				default:
				_result[_item.name] = _item.value;
			}
		};
		$.ajax({
			url: $(this).attr('action'),
			type: "POST",
			datatype: "json",
			contentType: 'application/json;charset=UTF-8',
			data: JSON.stringify(_result),
			success: function(data) {
				/*optional stuff to do after success */
				console.log(data);
				if (data === "success") {
					showAlert(true, '提交成功！', 'success', false, 500, function() {
						LoadAjaxContent(window.location.hash.substring(1), true);
					});
				} else {
					showAlert(true, '提交失败，请联系管理员。', 'danger', false, 2000);
				}
			}
		});
	})
};


$(document).ready(function() {
	LoadByoneTableScripts(tableReady);
	LoadTimePickerScript(AllTimePickers);
	LoadBootstrapValidatorScript(formValidate);
	WinMove();
	LoadChosenScript(function() {
		$.get('queryRules.do', function(data) {
			if (data.lenth <= 0) {
				return;
			}
			var $ruleSel = $('#ruleSel'),
			_i = -1,
			_rule;
			while (_rule = data[++_i]) {
				__ruleList[_rule.id] = _rule.ruleName;
				$('<option>').val(_rule.id).text(_rule.ruleName).appendTo($ruleSel);
			}
			$ruleSel.trigger("chosen:updated");
		});
		$('#ruleSel').chosen({
			disable_search_threshold: 10,
			search_contains: true,
			width: "200px",
			no_results_text: "没有对应结果!"
		});
	});
	$('#startTime').change(function(event) {
		/* Act on the event */
		alert('change');
	});
});

</script>