<div class="row">
	<div id="breadcrumb" class="col-xs-12">
		<ol class="breadcrumb pull-left">
			<li><a class="ajax-link" href="./ajax/dashboard.html">首页</a></li>
			<li><a href="#">安全管理</a></li>
			<li><a href="#">脆弱性扫描</a></li>
		</ol>
	</div>
	<!-- /#breadcrumb -->
</div>
<!-- /.row -->

<div class="row">
	<div class="col-xs-12 mb">
		<div class="box no-drop">
			<div class="box-header">
				<div class="box-name">
					<span>扫描任务</span>
				</div>
				<div class="box-icons">
					<a class="collapse-link">
						<i class="fa fa-chevron-up"></i>
					</a>
					<!-- <a class="expand-link">
						<i class="fa fa-expand"></i>
					</a> -->
				</div>
				<div class="no-move"></div>
			</div>
			<div class="box-content form-horizontal clearfix">
				<form action="addScanTask.do" id="taskForm" class="form-horizontal">
					<div class="form-group">
						<label for="stArea" class="control-label col-sm-2 col-xs-4">扫描目标：</label>
						<div class="col-xs-8">
							<input type="hidden" name="scanTargets" id="scanTargets">
							<textarea data-name="scanTargets" id="stArea" class="form-control" rows="5"></textarea>
						</div>
					</div>
					<div class="form-group">
						<label for="scanName" class="control-label col-sm-2 col-xs-4">任务名称：</label>
						<div class="col-xs-8"><input type="text" class="form-control" name="scanTaskName" data-name="scanTaskName" placeholder="任务名称" id="scanName" required></div>
					</div>
					<div class="form-group">
						<label for="" class="control-label col-xs-4 col-sm-3 col-md-2">动作：</label>
						<div class="col-xs-7">
							<div>
								<select data-name="scanType" name="scanType" class="form-control" id="scanType">
									<option value="year">每年</option>
									<option value="month">每月</option>
									<option value="day">每日</option>
								</select>
							</div>
							<div id="genTime">
								<div class="col-xs-4 no-padding month">
									<label class="pull-left control-label col-xs-2">月:</label>
									<div class="col-xs-8"><select name="month" class="form-control"></select></div>
								</div>
								<div class="col-xs-4 no-padding day">
									<label class="pull-left control-label col-xs-2">日:</label>
									<div class="col-xs-8"><select name="day" class="form-control"></select></div>
								</div>
								<div class="col-xs-4 no-padding hour">
									<label class="pull-left control-label col-xs-2">时:</label>
									<div class="col-xs-8"><select name="hour" class="form-control"></select></div>
								</div>
							</div>
						</div>
					</div>
					<!-- /.form-group -->
					<div class="form-group">
						<div class="col-xs-8 col-xs-offset-2">
							<button type="submit" class="btn btn-primary pull-right">提 交</button>
						</div>
					</div>
				</form>
			</div>
			<!-- /.box-content -->
		</div>
		<!-- /.box -->
	</div>
	<!-- /.col-xs-12 -->


	<div class="col-xs-12">
		<div class="box no-drop">
			<div class="box-header">
				<div class="box-name">
					<span>任务列表：</span>
				</div>
				<div class="box-icons" id="taskAction">
					<button href="#" class="btn btn-default btn-xs rely-on-table pull-left" data-func="delTask('{1}')" disabled>删除</button>
					<a class="collapse-link">
						<i class="fa fa-chevron-up"></i>
					</a>
					<!-- <a class="expand-link">
						<i class="fa fa-expand"></i>
					</a> -->
				</div>
				<div class="no-move"></div>
			</div>
			<div class="box-content clearfix">
				<table id="taskTable" class="table table-condensed table-striped table-bordered table-block table-hover byoneTable" action-handle="#taskAction">
					<thead>
						<tr>
							<th>任务序号</th>
							<th>任务名称</th>
							<th>扫描目标</th>
							<th>动作</th>
							<th>时间</th>
						</tr>
					</thead>
					<tbody>
						<tr class="template">
							<td data-name="id"></td>
							<td data-name="scanTaskName"></td>
							<td data-name="scanTargets"></td>
							<td data-name="scanType"></td>
							<td data-name="time"></td>
						</tr>
					</tbody>
				</table>

			</div>
			<!-- /.box-content -->
		</div>
		<!-- /.box -->
	</div>
	<!-- /.col-xs-12 -->

	<div class="col-xs-12">
		<div class="box no-drop">
			<div class="box-header">
				<div class="box-name">
					<span>结果列表：</span>
				</div>
				<div class="box-icons">
					<a class="collapse-link">
						<i class="fa fa-chevron-up"></i>
					</a>
					<!-- <a class="expand-link">
						<i class="fa fa-expand"></i>
					</a> -->
				</div>
				<div class="no-move"></div>
			</div>
			<div class="box-content clearfix">
				<table id="resultTable" class="table table-condensed table-striped table-bordered table-block table-hover byoneTable">
					<thead>
						<tr>
							<th>任务序号</th>
							<th>任务名称</th>
							<th>扫描目标</th>
							<th>高风险</th>
							<th>中风险</th>
							<th>低风险</th>
							<th>风险值</th>
						</tr>
					</thead>
					<tbody>
						<tr class="template">
							<td data-name="scanTaskId"></td>
							<td data-name="scanTaskName"></td>
							<td data-name="scanTarget"></td>
							<td data-name="highRisk"></td>
							<td data-name="midumRisk"></td>
							<td data-name="lowRisk"></td>
							<td data-name="risk"></td>
						</tr>
					</tbody>
				</table>

			</div>
			<!-- /.box-content -->
		</div>
		<!-- /.box -->
	</div>
	<!-- /.col-xs-12 -->

</div>
<!-- /.row -->

<script type="text/javascript">
	function delTask(taskId) {
		if(!confirm('删除操作不可逆，您确定要删除吗')) {
			return;
		}
		showAlert(true, '删除中...', 'info', true);
		$.get('deleteScanTask.do', {
			'id': taskId
		}, function(data) {
			if (data === "operateSuccess") {
				showAlert(true, '删除成功！', 'success', false, 500, function() {
					LoadAjaxContent(window.location.hash.substring(1), true);
				});
			} else {
				showAlert(true, '删除失败，请联系管理员。', 'danger', false, 2000);
			}
		});
	}
	function validatorReady() {
		$('#taskForm').bootstrapValidator({
			feedbackIcons: {
				valid: 'glyphicon glyphicon-ok',
				invalid: 'glyphicon glyphicon-remove',
				validating: 'glyphicon glyphicon-refresh'
			},
			fields: {
				'stArea': {
					selector: '#stArea',
					validators: {
						notEmpty: {},
						callback: {
							message: '扫描目标应为标准域名或ip地址，用换行分隔',
							callback: function(value, validator) {
								var _valLists = value.split('\n'),
								_length = _valLists.length;
								if (_length <= 0) {
									return false;
								}
								for (var i = 0; i < _length; i++) {
										// console.log(_valLists[i]);
										var _val = _valLists[i];
										if(!_val) {
											_valLists.splice(i, 1);
											continue;
										}
										if(!_valLists[i].match(/^((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]\d)|\d)(\.((25[0-5])|(2[0-4]\d)|(1\d\d)|([1-9]\d)|\d)){3}$|^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}$/))
											return false;
									};
									$('#scanTargets').val(_valLists);
									return true;
								}
							}
						}
					}
				}
			}).on('success.form.bv', function(e) {
				e.preventDefault();
				$.get($(this).attr('action'), $(this).serialize(), function(data) {
					/*optional stuff to do after success */
					console.log(data);
					LoadAjaxContent(window.location.hash.substring(1), true);
				});
			});
		}
		tableTrClick('#taskTable');
		window.$ && $(function() {
			LoadBootstrapValidatorScript(validatorReady);
			setUpListTable('#taskTable', 'queryScanTask.do', {
				dataId: 'id'
			});
			setUpListTable('#resultTable', 'queryScanResult.do', {
				dataId: 'id'
			});
			$('#scanType').change(function(event) {
				mdhSelector('#genTime', $(this).val());
			}).change();
		})
	</script>
